# APACHE

## Archivos de Configuración

```
[root@localhost httpd]# tree
.
├── conf
│   ├── httpd.conf                               -> archivo principal de configuración
│   └── magic                                    -> magic numbers para la deteccion de los tipos mime
├── conf.d
│   ├── adminer.conf                             -> Virtual Host
│   ├── autoindex.conf                           -> Configuración adicional para soporte a autoindex
│   ├── drupaldev.conf                           -> Virtual Host 
│   ├── php.conf                                 -> Soporte PHP
│   ├── README
│   ├── userdir.conf                             -> Habilitar sitios para usuarios
│   └── welcome.conf                             -> ???
├── conf.modules.d
│   ├── 00-base.conf                             -> Módulos Base
│   ├── 00-dav.conf                              -> Módulos para DAV
│   ├── 00-lua.conf                              -> Módulos para LUA. Permite extender el servicio con scripts LUA.
│   ├── 00-mpm.conf                              -> Tipo de worker a usar. 
│   ├── 00-proxy.conf                            -> Configuracion como Proxy
│   ├── 00-systemd.conf                          -> Configuración para trabajar junto a systemd
│   ├── 01-cgi.conf                              -> Configuración de CGI (sitios dinámicos en PERL por ej.)
│   ├── 10-php.conf                              -> Configuración de PHP
├── logs -> ../../var/log/httpd               
├── modules -> ../../usr/lib64/httpd/modules
└── run -> /run/httpd
```

## Archivos de ejemplo de configuración

En /usr/share/doc/httpd-2.4.6  se encuentra varios archivos que pueden ser tomados de ejemplo para configurar Apache HTTPD.

## Virtual Hosts

Un ejemplo sencillo para servir una aplicación, en este caso Adminer

```
<VirtualHost *:80>
    ServerAdmin webmaster@dummy-host.example.com
    DocumentRoot /var/www/adminer
    ServerName adminer
    ServerAlias adminer
    ErrorLog  /var/log/httpd/adminer_error.log
    CustomLog /var/log/httpd/adminer_custom.log common
</VirtualHost>
```

Virtual Host para DRUPAL

```
<VirtualHost *:80>
    ServerAdmin webmaster@dummy-host.example.com
    DocumentRoot /var/www/drupal/drupal8-dev
    <Directory /var/www/drupal/drupal8-dev>
       Options FollowSymLinks
       AllowOverride All
       Require all granted
       # Clean URL
       RewriteEngine On
       RewriteBase /
       RewriteCond %{REQUEST_FILENAME} !-f
       RewriteCond %{REQUEST_FILENAME} !-d
       RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
     </Directory>
    ServerName drupal8dev
    ServerAlias drupal8dev
    ErrorLog  /var/log/httpd/drupal/drupal8-dev_error.log
    CustomLog /var/log/httpd/drupal/drupal8-dev_custom.log common
</VirtualHost>

```



## Server Status

Con el modulo mod_status habilitado podemos crear en httpd.conf la siguiente sección

```
<IfModule mod_status.c> 
	# Allow server status reports generated by mod_status, 
	# with the URL of [servername...] 
	# Change the ".example.com" to match your domain to enable. 
	# 
	<Location /server-status> 
		SetHandler server-status 
		Order deny,allow 
		Allow from all 
	</Location> 
</IfModule>

```

Y reiniciarl el servicio. Luego podemos usar la URL `http://your.server.name/server-status?refresh=N` en un browser para ver estado del servidor y estadisticas de performance.

A machine-readable version of the status file is available by accessing the page `http://your.server.name/server-status?auto`. 

Para realizar troubleshooting se sugiere tener la directiva ExtendedStatus en On.

## Server Info

```
<IfModule mod_info.c>
   <Location /server-info>
      SetHandler server-info
      Order deny,allow
      Allow from 127.0.0.1
   </Location>
</IfModule>
```

## Hardening de Apache

Me baso en los siguientes enlaces

* https://www.owasp.org/index.php/SCG_WS_Apache#Summary
* https://groups.drupal.org/node/41320

Instalado out of box, DRUPAL 8 ofrece esta información en los HTTP Headers

```
Date: Fri, 05 Jan 2018 12:35:30 GMT
Server: Apache/2.4.6 (CentOS)
Cache-Control: must-revalidate, no-cache, private
X-Drupal-Dynamic-Cache: MISS
X-UA-Compatible: IE=edge
Content-language: en
X-Content-Type-Options: nosniff, nosniff
X-Frame-Options: SAMEORIGIN
Expires: Sun, 19 Nov 1978 05:00:00 GMT
X-Generator: Drupal 8 (https://www.drupal.org)
X-Drupal-Cache: HIT
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: text/html; charset=UTF-8
```

Solo con el header Server y X-Generator se está dando información mas suficiente para iniciar ataques.

### Server Header

Editar el ```/etc/httpd/conf/httpd.conf``` y agregar las siguientes líneas

```
ServerTokens ProductOnly
ServerSignature Off
```

### X-Generator Header

Para ocultar la version de Drupal ver https://drupal.stackexchange.com/questions/227368/remove-the-x-generator-header-from-the-response. Comentan que es más fácil usar un reverse proxy y cambiar los headers en el reverse proxy.

### Directory Listing

Agregar `Options -Indexes`  a la siguiente sección. En realidad a cada Directory en cada VirtualHost y en default.

```
<Directory /var/www/html/>
    Options -Indexes
    AllowOverride None
    Require all granted
</Directory>
```

### Módulos no necesarios (espcialmente para Drupal 8)

```mod_authz_core``` es requerido desde el ```.htaccess``` de Drupal 8 para asegurar los archivos que cumplen la regla de FilesMatch. Copio la sección.

```
<FilesMatch "\.(engine|inc|install|make|module|profile|po|sh|.*sql|theme|twig|tpl(\.php)?|xtmpl|yml)(~|\.sw[op]|\.bak|\.orig|\.save)?$|^(\.(?!well-known).*|Entries.*|Repository|Root|Tag|Template|composer\.(json|lock))$|^#.*#$|\.php(~|\.sw[op]|\.bak|\.orig|\.save)$">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order allow,deny
  </IfModule>
</FilesMatch>
```

Otros módulos requeridos

- mod_expires
- mod_rewrite
- mod_headers

En el enlace de drupal.org la recomendacion 

```
for each module in 00-base.conf do
	comment module
	systemctl restart httpd.service
	if httpd starts
		if test_ drupal() =  FAIL
		   uncomment module
		   systemctl restart httpd.service
	else
		systemctl restart httpd.service    
```

| Modulo                  | Estado | Uso                                      |
| ----------------------- | ------ | ---------------------------------------- |
| access_compat_module    | On     |                                          |
| actions_module          | Off    |                                          |
| alias_module            | On     |                                          |
| allowmethods_module     | On     |                                          |
| auth_basic_module       | Off    |                                          |
| auth_digest_module      | Off    |                                          |
| authn_anon_module       | Off    |                                          |
| authn_core_module       | Off    |                                          |
| authn_dbd_module        | Off    |                                          |
| authn_dbm_module        | Off    |                                          |
| authn_file_module       | Off    |                                          |
| authn_socache_module    | Off    |                                          |
| authz_core_module       | On     |                                          |
| authz_dbd_module        | Off    |                                          |
| authz_dbm_module        | Off    |                                          |
| authz_groupfile_module  | Off    |                                          |
| authz_host_module       | Off    |                                          |
| authz_owner_module      | Off    |                                          |
| authz_user_module       | Off    |                                          |
| autoindex_module        | On     |                                          |
| cache_module            | On     |                                          |
| cache_disk_module       | Off    |                                          |
| cache_socache_module    | On     |                                          |
| data_module             | Off    |                                          |
| dbd_module              | Off    |                                          |
| deflate_module          | On     |                                          |
| dir_module              | On     |                                          |
| dumpio_module           | Off    |                                          |
| echo_module             | Off    |                                          |
| env_module              | Off    |                                          |
| expires_module          | On     |                                          |
| ext_filter_module       | Off    |                                          |
| filter_module           | On     |                                          |
| headers_module          | On     |                                          |
| include_module          | On     |                                          |
| info_module             | Off    |                                          |
| log_config_module       | On     |                                          |
| logio_module            | Off    |                                          |
| macro_module            | Off    |                                          |
| mime_magic_module       | On     |                                          |
| mime_module             | On     |                                          |
| negotiation_module      | Off    |                                          |
| remoteip_module         | On     |                                          |
| reqtimeout_module       | On     |                                          |
| rewrite_module          | On     |                                          |
| setenvif_module         | On     | Requerido por mod_ssl                    |
| slotmem_plain_module    | On     |                                          |
| slotmem_shm_module      | On     |                                          |
| socache_dbm_module      | On     |                                          |
| socache_memcache_module | On     |                                          |
| socache_shmcb_module    | On     |                                          |
| status_module           | On     |                                          |
| substitute_module       | On     |                                          |
| suexec_module           | Off    |                                          |
| unique_id_module        | On     |                                          |
| unixd_module            | On     |                                          |
| userdir_module          | Off    |                                          |
| version_module          | On     |                                          |
| vhost_alias_module      | On     |                                          |
| watchdog_module         | On     | Requerido. No inicia el servicio sin el. |

Hasta aquí son 28 módulos menos que OutOfTheBox.
00-dav.conf

| Modulo          | Estado | Uso  |
| --------------- | ------ | ---- |
| dav_module      | Off    |      |
| dav_fs_module   | Off    |      |
| dav_lock_module | Off    |      |

00-lua.conf

| Modulo     | Estado | Uso  |
| ---------- | ------ | ---- |
| lua_module | Off    |      |

01-cgi.conf

| Modulo      | Estado | Uso  |
| ----------- | ------ | ---- |
| cgid_module | Off    |      |
| cgi_module  | Off    |      |

### Específicas de Drupal 8

#### Editar el robots.txt

Duplicar las secciones Directories y Paths. Eliminar las / al final



diff --changed-group-format='%<' --unchanged-group-format='' 00-base.conf 00-base.conf.orig

